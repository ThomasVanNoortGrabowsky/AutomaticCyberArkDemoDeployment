{
  "variables": {
    "boot_wait":       "5s",
    "disk_size":       "40960",
    "iso_url":         "https://software-download.microsoft.com/download/sg/20348.169.210806-2348.fe_release_svc_refresh_SERVER_EVAL_x64FRE_en-us.iso",
    "iso_checksum":    "4f1457c4fe14ce48c9b2324924f33ca4f0470475e6da851b39ccbf98f44e7852",
    "memsize":         "2048",
    "numvcpus":        "2",
    "vm_name":         "Win2022_GUI",
    "winrm_username":  "Administrator",
    "winrm_password":  "packer",
    "virtio_iso_path": "virtio-win-0.1.229.iso"
  },
  "builders": [
    {
      "type":            "vmware-iso",
      "guest_os_type":   "windows2022srv-64",
      "vm_name":         "{{user `vm_name`}}",
      "boot_wait":       "{{user `boot_wait`}}",
      "disk_size":       "{{user `disk_size`}}",
      "iso_url":         "{{user `iso_url`}}",
      "iso_checksum":    "{{user `iso_checksum`}}",
      "communicator":    "winrm",
      "winrm_username":  "{{user `winrm_username`}}",
      "winrm_password":  "{{user `winrm_password`}}",
      "winrm_use_ssl":   true,
      "winrm_insecure":  true,
      "winrm_timeout":   "4h",
      "floppy_files":    ["scripts/bios/gui/autounattend.xml"],
      "shutdown_command":"shutdown /s /t 5 /f /d p:4:1 /c \"Packer Shutdown\"",
      "shutdown_timeout":"30m",
      "vmx_data": {
        "memsize":           "{{user `memsize`}}",
        "numvcpus":          "{{user `numvcpus`}}",
        "virtualHW.version": "14",
        "scsi0.virtualDev":  "lsisas1068"
      }
    }
  ],
  "provisioners": [
    {
      "type":             "powershell",
      "scripts":          ["scripts/setup.ps1"],
      "valid_exit_codes": [0, 1, 3010]
    },
    {
      "type":             "powershell",
      "pause_before":     "1m",
      "scripts":          ["scripts/cleanup.ps1"],
      "valid_exit_codes": [0, 1, 3010, 123]
    },
    {
      "type":       "powershell",
      "pause_before":"30s",
      "inline": [
        "Write-Host '==> Enabling WinRM listener and firewall rules…'",
        "winrm quickconfig -quiet",
        "winrm set winrm/config/service/auth @{Basic='true'}",
        "winrm set winrm/config/service @{AllowUnencrypted='true'}",
        "",
        "Write-Host '==> Generating unattend.xml for first-boot WinRM setup…'",
        "$u = @\"<unattend xmlns='urn:schemas-microsoft-com:unattend'>",
        "  <settings pass='oobeSystem'>",
        "    <component name='Microsoft-Windows-Shell-Setup' processorArchitecture='amd64' publicKeyToken='31bf3856ad364e35' language='neutral' versionScope='nonSxS' xmlns:wcm='http://schemas.microsoft.com/WMIConfig/2002/State'>",
        "      <FirstLogonCommands>",
        "        <SynchronousCommand wcm:action='add'>",
        "          <Order>1</Order>",
        "          <CommandLine>powershell -ExecutionPolicy Bypass -Command \"winrm quickconfig -quiet; winrm set winrm/config/service/auth @{Basic='true'}; winrm set winrm/config/service @{AllowUnencrypted='true'}\"</CommandLine>",
        "          <Description>Enable WinRM on first boot</Description>",
        "        </SynchronousCommand>",
        "      </FirstLogonCommands>",
        "    </component>",
        "  </settings>",
        "</unattend>\"@",
        "Set-Content -Path C:\\Windows\\Panther\\unattend.xml -Value $u -Encoding UTF8",
        "",
        "Write-Host '==> Running Sysprep and shutting down…'",
        "& \"$env:windir\\System32\\Sysprep\\sysprep.exe\" /generalize /oobe /shutdown /unattend:C:\\Windows\\Panther\\unattend.xml"
      ],
      "valid_exit_codes": [0]
    }
  ]
}
