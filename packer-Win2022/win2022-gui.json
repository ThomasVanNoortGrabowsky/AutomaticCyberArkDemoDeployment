"provisioners": [
  {
    "type":             "powershell",
    "scripts":          ["scripts/setup.ps1"],
    "valid_exit_codes": [0, 1, 3010]
  },
  {
    "type":             "powershell",
    "pause_before":     "1m",
    "scripts":          ["scripts/cleanup.ps1"],
    "valid_exit_codes": [0, 1, 3010, 123]
  },
  {
    "type":       "powershell",
    "pause_before":"30s",
    "inline": [
      "Write-Host '==> Enabling WinRM listener and firewall rules…'",
      "winrm quickconfig -quiet",
      "winrm set winrm/config/service/auth @{Basic='true'}",
      "winrm set winrm/config/service @{AllowUnencrypted='true'}",
      "",
      "Write-Host '==> Generating unattend.xml for first-boot WinRM setup…'",
      "$u = @\"<unattend xmlns='urn:schemas-microsoft-com:unattend'>",
      "  <settings pass='oobeSystem'>",
      "    <component name='Microsoft-Windows-Shell-Setup' processorArchitecture='amd64' publicKeyToken='31bf3856ad364e35' language='neutral' versionScope='nonSxS' xmlns:wcm='http://schemas.microsoft.com/WMIConfig/2002/State'>",
      "      <FirstLogonCommands>",
      "        <SynchronousCommand wcm:action='add'>",
      "          <Order>1</Order>",
      "          <CommandLine>powershell -ExecutionPolicy Bypass -Command \"winrm quickconfig -quiet; winrm set winrm/config/service/auth @{Basic='true'}; winrm set winrm/config/service @{AllowUnencrypted='true'}\"</CommandLine>",
      "          <Description>Enable WinRM on first boot</Description>",
      "        </SynchronousCommand>",
      "      </FirstLogonCommands>",
      "    </component>",
      "  </settings>",
      "</unattend>\"@",
      "Set-Content -Path C:\\Windows\\Panther\\unattend.xml -Value $u -Encoding UTF8",
      "",
      "Write-Host '==> Running Sysprep and shutting down…'",
      "& \"$env:windir\\System32\\Sysprep\\sysprep.exe\" /generalize /oobe /shutdown /unattend:C:\\Windows\\Panther\\unattend.xml"
    ],
    "valid_exit_codes": [0]
  }
]
